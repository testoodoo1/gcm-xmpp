<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>proto.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#createServer">createServer</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">proto.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>var sipStatus = require('sip-status') ;
var debug = require('debug')('connect:dispatcher');
var Agent = require('./client').Agent ;
var EventEmitter = require('events').EventEmitter ;
var flatten = require('array-flatten');
var delegate = require('delegates') ;
var slice = Array.prototype.slice ;

var app = module.exports = {};

app.connect = function() {
  var self = this ;
  var client = new Agent( this );
  for( var prop in this.params ) {
    client.set(prop, this.params[prop]) ;
  }
  for( var method in this.routedMethods ) {
    client.route( method ) ;
  }

  //propogate drachtio-client events to my listeners
  ['connect','close','error','reconnecting'].forEach( function(event){
    client.on(event, function() {
      var args = Array.prototype.slice.call(arguments) ;
      EventEmitter.prototype.emit.apply(self, [event].concat(args)) ;
    }) ;
  }) ;

  this._cachedEvents.forEach( function(event){
    app.on(event); 
  }) ;
  this._cachedEvents = [] ;

  //delegate some drachtio-client methods and accessors
  delegate(this, 'client')
    .method('request')
    .method('disconnect')
    .method('get')
    .method('set')
    .getter('idle') ;

  client.connect.apply(client, arguments);
  this.client = client ;
  return client ;
};

app.request = function() {
  throw new Error('cannot call app#request in unconnected state') ;
} ;

app.set = function( prop, value ) {
  this.params[prop] = value ;
};

app.get = function( prop ) {
  return this.params[prop] ;
};


/**
 * Utilize the given middleware `handle` to the given `method`,
 * defaulting to _*_, which means execute for all methods. 
 *
 * @param {String|Function} method or callback 
 * @param {Function} callback 
 * @return {Server} for chaining
 * @api public
 */

app.use = function(fn){
  var self = this ;
  var offset = 0 ;
  var method = '*' ;

  // disambiguate app.use([fn])
  if (typeof fn !== 'function') {
    var arg = fn;

    while (Array.isArray(arg) &amp;&amp; arg.length !== 0) {
      arg = arg[0];
    }

    // first arg is the method
    if (typeof arg !== 'function') {
      offset = 1;
      method = fn;
    }
  }

  var fns = flatten(slice.call(arguments, offset));

  if (fns.length === 0) {
    throw new TypeError('app.use() requires middleware functions');
  }

  fns.forEach(function (fn) {
    // wrap sub-apps
    if ('function' === typeof fn.handle) {
      var server = fn;
      fn.method = method;
      fn = function(req, res, next){
        server.handle(req, res, next);
      };
    }

    debug('use %s %s', method || '*', fn.name || 'anonymous');
    self.stack.push({ method: method, handle: fn });
  }) ;

  if( typeof method === 'string' &amp;&amp; method !== '*' &amp;&amp; !(method in this.routedMethods)) {
    this.routedMethods[method] = true ;
    if( this.client ) this.client.route(method) ;
  }

  return this;
};

/**
 * Handle server requests, punting them down
 * the middleware stack.
 *
 * @api private
 */

app.handle = function(req, res, out) {
  var stack = this.stack ;
  var index = 0;

  function next(err) {
    var layer;

    // next callback
    layer = stack[index++];

    // all done
    if (!layer || res.finalResponseSent) {
      // delegate to parent
      if (out) return out(err);

      // unhandled error
      if (err) {
        // default to 500
        var finalResponseSent = res.finalResponseSent ;

        console.error('some layer barfed an error: ', err) ;
        if (res.status &lt; 400 || !req.status) res.status = 500;
        debug('default %s', res.status);

        // respect err.status
        if (err.status) res.status = err.status;

        // production gets a basic error message
        var msg = sipStatus[res.status] ;

        // log to stderr in a non-test env
        console.error(err.stack || err.toString());
        if (finalResponseSent) return ; 
        res.send(res.status, msg);
      } else {
        if( req.method !== 'ACK' ) {
          res.send(404) ;
        }
      }
      return;
    }

    try {

      // skip this layer if the route doesn't match.
      if (0 !== req.method.toLowerCase().indexOf(layer.method.toLowerCase()) &amp;&amp; layer.method !== '*') return next(err);

      debug('%s %s : %s', layer.handle.name || 'anonymous', layer.method, req.uri);
      var arity = layer.handle.length;
      if (err) {
        if (arity === 4) {
          layer.handle(err, req, res, next);
        } else {
          next(err);
        }
      } else if (arity &lt; 4) {
        layer.handle(req, res, next);
      } else {
        next();
      }
    } catch (e) {
      console.error(e.stack) ;
      next(e);
    }
  }
  next();
};
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Sun May 15 2016 20:38:32 GMT-0400 (EDT) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
